<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#161625">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PDX Prompt</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root{--primary-color:#6a11cb;--secondary-color:#2575fc;--accent-color:#f72585;--text-light:#f0f2f5;--text-dark:#121212;--bg-dark:#161625;--bg-darker:#10101d;--card-bg:rgba(22,22,39,.85);--menu-width:280px}
        body.light-mode{--primary-color:#4361ee;--secondary-color:#3a0ca3;--text-light:#212529;--text-dark:#f8f9fa;--bg-dark:#f8f9fa;--bg-darker:#e9ecef;--card-bg:rgba(255,255,255,.9)}
        *{-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-family:'Poppins',sans-serif;margin:0;padding:0}
        body{background-color:var(--bg-dark);color:var(--text-light);height:100dvh;overflow:hidden;overscroll-behavior-y:contain}
        .view{display:none; flex-direction:column; height:100%;}
        .view.active{display:flex;}
        #app-container, #ideaverse-container, #saved-container, #stylist-container {position:relative;transition:transform .4s ease, filter .4s ease;}
        #app-container.menu-open, #app-container.page-open, 
        #ideaverse-container.menu-open, #ideaverse-container.page-open,
        #saved-container.menu-open, #saved-container.page-open,
        #stylist-container.menu-open, #stylist-container.page-open {
            transform:translateX(calc(-1 * var(--menu-width))); 
            filter: blur(5px) brightness(0.7);
        }
        header{padding-top:calc(env(safe-area-inset-top, 0px) + 10px);padding-right:15px;padding-bottom:5px;padding-left:15px;display:flex;justify-content:space-between;align-items:center;background-color:var(--bg-dark);position:relative;z-index:10;overflow:hidden;flex-shrink:0;}
        #app-title, #page-view-title{font-size:1.5rem;font-weight:700;background:linear-gradient(45deg,var(--primary-color),var(--accent-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent;transition:all .3s ease}
        .top-button{background:0 0;border:none;color:var(--text-light);font-size:22px;cursor:pointer;width:44px;height:44px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .3s ease}
        body.light-mode .top-button{color:var(--text-dark)}
        #menu-btn, #menu-btn-ideaverse {background:linear-gradient(45deg,var(--primary-color),var(--secondary-color));color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.2)}
        .top-button:hover{transform:scale(1.1);box-shadow:0 6px 15px rgba(0,0,0,.3)}
        #header-left{display:flex;align-items:center;gap:5px}
        #search-btn i{background:linear-gradient(45deg,var(--accent-color),var(--primary-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        #refresh-btn i{background:linear-gradient(45deg,var(--secondary-color),var(--accent-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .top-button.refreshing i{animation:spin 1s ease-in-out infinite}
        #search-bar-container{position:absolute;top:0;left:0;width:100%;height:100%;background-color:var(--bg-dark);display:flex;align-items:center;padding:0 15px;transform:translateY(-100%);opacity:0;transition:all .4s cubic-bezier(.68,-.55,.27,1.55);z-index:11}
        header.search-active #search-bar-container{transform:translateY(0);opacity:1}
        header.search-active #app-title,header.search-active #page-view-title,header.search-active #menu-btn,header.search-active #search-btn,header.search-active #back-btn-header,header.search-active #refresh-btn{transform:scale(0);opacity:0}
        #search-input{flex-grow:1;height:44px;border:none;background:var(--bg-darker);border-radius:22px;padding:0 20px;color:var(--text-light);font-size:1rem}
        #search-input:focus{outline:none;box-shadow:0 0 0 2px var(--primary-color)}
        #close-search-btn{font-size:24px;margin-left:10px}
        .tabs{display:flex;padding:5px;margin:5px 15px 10px;background-color:var(--bg-darker);border-radius:50px;transition:all .3s ease;flex-shrink:0}
        .tab-btn{flex:1;padding:10px;background:transparent;border:none;color:rgba(255,255,255,.6);font-size:.9rem;font-weight:600;cursor:pointer;position:relative;transition:all .3s ease;z-index:1;border-radius:50px;text-align:center}
        .tab-btn.active{color:#fff;background-color:var(--primary-color);box-shadow:0 4px 15px rgba(106,17,203,.4)}
        .tab-btn:not(.active):hover{background-color:rgba(255,255,255,.1)}
        .gallery-container{flex:1;position:relative;overflow:hidden;touch-action:pan-y}.slide{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;opacity:0;padding:15px;will-change:transform,opacity;transition:opacity .5s ease,transform .5s cubic-bezier(.2,.8,.2,1)}.slide.active{opacity:1;transform:translateY(0);z-index:1}.slide.prev{opacity:0;transform:translateY(-30px)}.slide.next{opacity:0;transform:translateY(30px)}.image-wrapper{display:flex;justify-content:center;align-items:center;width:100%;flex:1;min-height:0}.image-container{position:relative;width:100%;height:100%;display:flex;justify-content:center;align-items:center}.image-container img{max-width:100%;max-height:100%;object-fit:contain;border-radius:16px;box-shadow:0 15px 30px rgba(0,0,0,.3)}.prompt-card{width:100%;max-width:600px;margin-top:15px;background:var(--card-bg);border-radius:20px;padding:20px;padding-top:30px;backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);animation:fadeInUp .5s ease-out;position:relative}body.light-mode .prompt-card{border:1px solid rgba(0,0,0,.1)}.prompt-actions{position:absolute;top:-22px;right:20px;display:flex;gap:10px}.action-icon{width:44px;height:44px;border-radius:50%;background:linear-gradient(45deg,var(--primary-color),var(--secondary-color));color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 10px rgba(0,0,0,.3)}.action-icon:hover{transform:translateY(-3px)}.action-icon.active{background:var(--accent-color)}
        .prompt-meta-container{display:flex;flex-direction:column;align-items:center;background-color:var(--bg-darker);border-radius:16px;padding:12px 20px;margin-bottom:15px;border:1px solid rgba(255,255,255,0.1)}
        body.light-mode .prompt-meta-container{border-color:rgba(0,0,0,0.1)}
        .prompt-title{font-size:1.1rem;font-weight:600;color:var(--accent-color);margin-bottom:8px}
        .like-count-display{display:flex;align-items:center;gap:8px;font-size:1rem;font-weight:500;color:var(--text-light)}
        body.light-mode .like-count-display{color:var(--text-dark)}
        .like-count-display i{color:var(--accent-color);font-size:.9rem}
        .tags-container{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:20px}
        .tag{background-color:rgba(255,255,255,.1);color:var(--text-light);padding:5px 12px;border-radius:20px;font-size:.8rem;cursor:pointer;transition:all .2s ease;text-transform:capitalize}
        .tag:hover{background-color:var(--primary-color);color:#fff}
        .prompt-text{font-size:1rem;line-height:1.6;max-height:80px;overflow-y:auto;background-color:var(--bg-darker);border:1px solid rgba(255,255,255,.2);padding:15px;border-radius:12px;text-align:left;margin-bottom:20px}
        body.light-mode .prompt-text{border-color:rgba(0,0,0,.15)}
        .action-buttons{display:flex;gap:15px}.action-btn{align-items:center;border:none;border-radius:12px;cursor:pointer;display:flex;flex:1;font-size:1rem;font-weight:600;gap:10px;justify-content:center;padding:12px;transition:all .3s ease}.copy-btn{background:var(--primary-color);color:#fff}.generator-btn{background:var(--secondary-color);color:#fff}
        .slide-counter{bottom:20px;background:rgba(0,0,0,.5);border-radius:50px;font-size:.9rem;font-weight:500;left:50%;padding:6px 15px;position:fixed;transform:translateX(-50%);z-index:10;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s,bottom .3s}.slide-counter.show{opacity:1;visibility:visible;bottom:40px}
        .main-menu{background:var(--bg-dark);box-shadow:-5px 0 15px rgba(0,0,0,.3);height:100vh;overflow-y:auto;padding:20px;position:fixed;right:0;top:0;transform:translateX(100%);transition:transform .4s ease;width:var(--menu-width);z-index:999}.main-menu.open{transform:translateX(0)}.error-message{text-align:center;padding:50px 20px}
        .loader{animation:spin 1s linear infinite;border:4px solid rgba(255,255,255,.1);border-top-color:var(--accent-color);border-radius:50%;height:50px;width:50px;position:absolute;top:calc(50% - 25px);left:calc(50% - 25px)}@keyframes spin{to{transform:rotate(360deg)}}
        .menu-header{align-items:center;border-bottom:1px solid rgba(255,255,255,.1);display:flex;justify-content:space-between;margin-bottom:30px;padding-bottom:15px}body.light-mode .menu-header{border-bottom-color:rgba(0,0,0,.1)}.menu-title{color:var(--accent-color);font-size:1.5rem;font-weight:700}.close-menu{background:0 0;border:none;color:var(--text-light);font-size:22px;cursor:pointer;width:44px;height:44px;display:flex;align-items:center;justify-content:center;border-radius:50%}body.light-mode .close-menu{color:var(--text-dark)}.menu-section{margin-bottom:25px}.menu-section-title{align-items:center;color:var(--primary-color);display:flex;font-size:1rem;font-weight:600;gap:10px;margin-bottom:15px}.menu-item{align-items:center;background:rgba(255,255,255,.05);border-radius:8px;color:var(--text-light);cursor:pointer;display:flex;margin-bottom:8px;padding:12px 15px;transition:all .3s ease}body.light-mode .menu-item{background:rgba(0,0,0,.05)}.menu-item:hover{background:rgba(255,255,255,.1);transform:translateX(5px)}body.light-mode .menu-item:hover{background:rgba(0,0,0,.1)}.menu-item i{color:var(--accent-color);font-size:18px;margin-right:12px;text-align:center;width:24px}.menu-item-text{font-size:.95rem}
        #notification{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(22,22,39,.9);color:#fff;padding:12px 25px;border-radius:50px;z-index:1000;opacity:0;transition:all .3s;backdrop-filter:blur(10px);visibility:hidden}
        #notification.show{opacity:1;bottom:calc(env(safe-area-inset-bottom, 0px) + 95px);visibility:visible}
        #stylist-container #notification.show, #ideaverse-container #notification.show {bottom:calc(env(safe-area-inset-bottom, 0px) + 20px) !important;}
        .saved-header{display:flex;align-items:center;padding:10px 15px;background-color:var(--bg-darker);flex-shrink:0}.saved-header h1{flex-grow:1;text-align:center;margin:0;font-size:1.5rem;color:var(--accent-color);font-weight:700;padding-right:0;}.saved-header .back-btn{position:absolute;left:15px;}.saved-header .header-action-btn{position:absolute;right:15px;width:auto;height:44px;padding:0 15px;}
        .back-btn{background:0 0;border:none;font-size:22px;color:var(--text-light);cursor:pointer;width:44px;height:44px}
        .saved-list-wrapper{flex-grow:1;overflow-y:auto}.saved-list{padding:15px;display:grid;grid-template-columns:1fr;gap:12px}
        .saved-item{display:flex;align-items:center;background:var(--card-bg);padding:10px;border-radius:12px;cursor:pointer;transition:background-color .3s;position:relative;padding-right:50px}
        .saved-item:hover{background-color:rgba(255,255,255,.1)}
        .saved-item img{width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:15px;flex-shrink:0}
        .saved-item span{flex:1;-webkit-box-orient:vertical;-webkit-line-clamp:2;display:-webkit-box;overflow:hidden}
        .no-saved-message{text-align:center;padding:50px;opacity:.7;font-size:1.1rem}
        .delete-saved-btn{position:absolute;top:50%;right:10px;transform:translateY(-50%);background:none;border:none;color:var(--accent-color);font-size:20px;cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background-color .2s}
        .delete-saved-btn:hover{background-color:rgba(247,37,133,.2)}
        #grid-container{display:none;flex-grow:1;overflow-y:auto;padding:15px}.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px}.grid-item{position:relative;cursor:pointer}.grid-item img{width:100%;height:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;display:block}.pin-indicator{position:absolute;top:10px;right:10px;color:#fff;background-color:var(--accent-color);width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:14px;box-shadow:0 2px 5px rgba(0,0,0,.3)}
        #app-container.grid-mode .gallery-container, #app-container.grid-mode .slide-counter { display: none; }
        #app-container.grid-mode #grid-container { display: block; }
        #app-container.slider-mode .tabs, #app-container.slider-mode #grid-container { display: none; }
        #app-container.slider-mode .gallery-container { display: block; }
        #page-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1001;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px)}
        #page-overlay.show{opacity:1;visibility:visible}
        #page-content{background-color:var(--bg-darker);border-radius:20px;width:90%;max-width:500px;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.3);transform:scale(.95);opacity:0;transition:transform .3s,opacity .3s}
        #page-overlay.show #page-content{transform:scale(1);opacity:1}
        .page-header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;border-bottom:1px solid rgba(255,255,255,.1);flex-shrink:0}
        .page-title{font-size:1.2rem;font-weight:600;color:var(--accent-color)}
        .page-body{padding:25px;overflow-y:auto;line-height:1.7}
        .page-body h2{color:var(--primary-color);font-size:1.1rem;margin-bottom:10px}
        .page-body h3{color:var(--primary-color);font-size:1rem;margin-bottom:10px}
        .page-body p{margin-bottom:20px;opacity:.9}
        .page-body p:last-child{margin-bottom:0}
        .page-body strong { color: var(--accent-color); }
        #alert-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);z-index:1002;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
        #alert-overlay.show{opacity:1;visibility:visible}
        #alert-box{background-color:var(--bg-darker);border-radius:16px;width:90%;max-width:320px;padding:25px;box-shadow:0 5px 25px rgba(0,0,0,.3);transform:scale(.9);opacity:0;transition:transform .3s,opacity .3s}
        #alert-overlay.show #alert-box{transform:scale(1);opacity:1}
        #alert-title{color:var(--accent-color);margin:0 0 10px;font-size:1.2rem}
        #alert-message{margin:0 0 20px;line-height:1.6;opacity:.9}
        .alert-checkbox-wrapper{display:flex;align-items:center;margin-bottom:20px;font-size:.9rem}
        #alert-dont-show-again{margin-right:10px}
        .alert-buttons{display:flex;gap:10px;justify-content:flex-end}
        .alert-buttons button{border:none;border-radius:8px;padding:10px 20px;font-size:1rem;font-weight:600;cursor:pointer}
        #alert-cancel-btn{background-color:var(--bg-dark);color:var(--text-light)}
        #alert-confirm-btn{background-color:var(--primary-color);color:#fff}
        #initial-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-dark); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.3s ease; }
        
        /* AI STYLIST WIZARD STYLES */
        #stylist-container { overflow: hidden; }
        #stylist-content-wrapper { flex-grow: 1; padding: 20px 20px 0 20px; overflow-y: auto; scroll-behavior: smooth; }
        .stylist-step { margin-bottom: 30px; animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .stylist-progress-bar { width: 100%; height: 8px; background-color: var(--bg-darker); border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .stylist-progress-bar-inner { height: 100%; background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); border-radius: 4px; transition: width .4s ease; }
        .stylist-question { font-size: 1.5rem; font-weight: 600; text-align: center; margin-bottom: 25px; line-height: 1.4; }
        .stylist-options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .stylist-option-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; background-color: var(--bg-darker); border-radius: 16px; padding: 20px 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease; position: relative; }
        .stylist-option-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .stylist-option-card.selected { border-color: var(--accent-color); background: var(--primary-color); }
        .stylist-option-card.selected i, .stylist-option-card.selected span { color: #fff; }
        .stylist-option-card i { font-size: 2.5rem; margin-bottom: 12px; transition: all .3s ease; color: var(--accent-color); }
        .stylist-option-card span { font-size: 1rem; font-weight: 500; transition: color .3s ease; }
        .stylist-text-input { width: 100%; background: var(--bg-darker); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; font-size: 1rem; color: var(--text-light); margin-top: 10px; }
        .stylist-text-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color); }
        .stylist-final-card { background: var(--bg-darker); border-radius: 20px; padding: 30px; text-align: center; }
        .stylist-final-card h2 { color: var(--accent-color); font-size: 1.8rem; margin-bottom: 20px; }
        .stylist-final-card .action-btn { width: 100%; margin-top: 15px; }
        #stylist-live-preview-bar { flex-shrink: 0; background-color: var(--bg-darker); padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); box-shadow: 0 -5px 15px rgba(0,0,0,0.2); padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 15px); animation: slideInUp 0.5s ease-out; }
        @keyframes slideInUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        #live-prompt-output { background-color: var(--bg-dark); min-height: 40px; max-height: 80px; overflow-y: auto; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.6; color: rgba(255,255,255,0.8); }
        #live-prompt-actions { display: flex; gap: 10px; }
        #live-prompt-actions .action-btn { font-size: 0.9rem; padding: 10px; }
        #language-toggle-btn { background-color: var(--bg-darker); border: 1px solid var(--primary-color); color: var(--text-light); font-weight: 700; font-size: 0.9rem; width: 50px; border-radius: 22px; }

        /* --- IDEA-VERSE STYLES (NEW) --- */
        #ideaverse-container { background: var(--bg-darker); }
        #ideaverse-container header { background: var(--bg-darker); }
        #ideaverse-header-title { background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .ideaverse-welcome-screen, .ideaverse-generator-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; height: 100%; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .ideaverse-title { font-size: 2rem; font-weight: 700; margin-bottom: 10px; background: linear-gradient(45deg, var(--accent-color), var(--primary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .ideaverse-subtitle { font-size: 1.1rem; opacity: 0.8; margin-bottom: 40px; }
        .ideaverse-category-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 400px; }
        .idea-category-card { background: linear-gradient(145deg, var(--bg-dark), var(--bg-darker)); padding: 25px 15px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1); }
        .idea-category-card:hover { transform: translateY(-8px) scale(1.05); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .idea-category-card i { font-size: 2.5rem; margin-bottom: 15px; color: var(--accent-color); }
        .idea-category-card span { font-size: 1rem; font-weight: 600; }
        .ideaverse-generator-screen .ideaverse-title { font-size: 1.5rem; }
        #idea-card { margin: 30px 0; background: var(--card-bg); border-radius: 20px; padding: 30px; min-height: 200px; width: 100%; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 1.2rem; line-height: 1.6; border: 1px solid var(--primary-color); box-shadow: 0 0 20px rgba(106, 17, 203, 0.3); transition: all 0.3s ease; }
        #idea-card.generating { animation: generating-pulse 0.8s infinite alternate; }
        @keyframes generating-pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.02); opacity: 1; } }
        #generate-idea-btn { background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); color: #fff; font-size: 1.2rem; font-weight: 700; padding: 18px 30px; border-radius: 50px; border: none; cursor: pointer; transition: transform 0.2s ease; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        #generate-idea-btn:active { transform: scale(0.95); }
        .idea-actions { display: flex; gap: 15px; margin-top: 20px; }
        .idea-action-btn { background: var(--bg-dark); border: 1px solid var(--secondary-color); color: var(--text-light); padding: 10px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .idea-action-btn i { font-size: 1rem; }
        
    </style>
</head>
<body>

<!-- Initial Loader -->
<div id="initial-loader">
    <div class="loader"></div>
</div>

<!-- Main App for Prompts -->
<div id="app-container" class="view">
    <header id="header">
        <div id="header-left">
            <button id="back-btn-header" class="top-button" style="display: none;"><i class="fas fa-arrow-left"></i></button>
            <button id="search-btn" class="top-button"><i class="fas fa-search"></i></button>
            <button id="refresh-btn" class="top-button"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div id="app-title">PDX Prompt</div>
        <div id="page-view-title" style="display:none;"></div>
        <button id="menu-btn" class="top-button"><i class="fas fa-bars"></i></button>
        <div id="search-bar-container">
            <input type="text" id="search-input" placeholder="Search prompts...">
            <button id="close-search-btn" class="top-button"><i class="fas fa-times"></i></button>
        </div>
    </header>
    <div class="tabs">
        <button class="tab-btn" data-tab="foryou">For You</button>
        <button class="tab-btn" data-tab="new">New</button>
        <button class="tab-btn" data-tab="trending">Trending</button>
    </div>
    <div class="gallery-container" id="gallery-container"></div>
    <div class="slide-counter" id="slide-counter"></div>
    <div id="grid-container"></div>
</div>

<!-- IdeaVerse Container -->
<div id="ideaverse-container" class="view">
    <header>
        <button class="back-btn" id="ideaverse-back-btn"><i class="fas fa-arrow-left"></i></button>
        <h1 id="ideaverse-header-title" style="font-size:1.5rem; font-weight:700;">IdeaVerse</h1>
        <button class="top-button" id="menu-btn-ideaverse"><i class="fas fa-bars"></i></button>
    </header>
    <div id="ideaverse-content" style="flex: 1; overflow-y: auto;">
        <!-- IdeaVerse screens will be injected here -->
    </div>
</div>


<!-- Other Views (Saved, Stylist) -->
<div id="saved-container" class="view">
    <header class="saved-header">
        <button class="back-btn"><i class="fas fa-arrow-left"></i></button>
        <h1>Saved Prompts</h1>
    </header>
    <div class="saved-list-wrapper"></div>
</div>
<div id="stylist-container" class="view">
    <header class="saved-header">
        <button class="back-btn" id="stylist-back-btn"><i class="fas fa-arrow-left"></i></button>
        <h1>AI Prompt Wizard</h1>
        <button id="language-toggle-btn" class="top-button header-action-btn">EN</button>
    </header>
    <div id="stylist-content-wrapper"></div>
    <div id="stylist-live-preview-bar">
        <div id="live-prompt-output">Choose an option to begin...</div>
        <div id="live-prompt-actions" class="action-buttons">
            <button id="stylist-copy-btn" class="action-btn copy-btn"><i class="fas fa-copy"></i><span>Copy</span></button>
            <button id="stylist-reset-btn" class="action-btn generator-btn"><i class="fas fa-sync-alt"></i><span>Reset</span></button>
        </div>
    </div>
</div>

<!-- Common UI Elements -->
<div class="main-menu" id="main-menu"></div>
<div id="notification"></div>
<div id="page-overlay">
    <div id="page-content">
        <div class="page-header">
            <h2 class="page-title"></h2>
            <button id="close-page-btn" class="top-button"><i class="fas fa-times"></i></button>
        </div>
        <div class="page-body"></div>
    </div>
</div>
<div id="alert-overlay">
    <div id="alert-box">
        <h3 id="alert-title">External Link</h3>
        <p id="alert-message"></p>
        <div class="alert-checkbox-wrapper">
            <input type="checkbox" id="alert-dont-show-again">
            <label for="alert-dont-show-again">Don't show this again</label>
        </div>
        <div class="alert-buttons">
            <button id="alert-cancel-btn">Cancel</button>
            <button id="alert-confirm-btn">Continue</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
    // --- CONFIG & INITIALIZATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDDQKXHk26A4oQZEQZ3uW73JcrVHd3c7e0",
        authDomain: "pdx-prompt-app.firebaseapp.com",
        databaseURL: "https://pdx-prompt-app-default-rtdb.firebaseio.com",
        projectId: "pdx-prompt-app",
        storageBucket: "pdx-prompt-app.appspot.com",
        messagingSenderId: "1040385203422",
        appId: "1:1040385203422:web:e0bf5809b5972798d7f64f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const promptsRef = db.ref('prompts');
    const homepageRef = db.ref('homepageConfig');
    // NEW/CORRECTED References for IdeaVerse
    const ideaCategoriesRef = db.ref('ideaCategories');
    const ideaTemplatesRef = db.ref('ideaTemplates');
    const PAGE_SIZE = 20;

    // --- STATE MANAGEMENT ---
    const appState = {
        allPrompts: {}, forYouData: [], trendingData: [], newData: [], savedItems: [],
        likedItems: [], currentSlideData: [], currentIndex: 0, currentTab: 'new',
        isSearchActive: false, isLoading: false, isLoadingMore: false,
        hasMoreNewData: true, lastNewPromptTimestamp: null, searchDebounceTimeout: null,
        currentLanguage: 'hi', 
        stylistAnswers: {}, stylistHistory: [],
        // NEW/CORRECTED state for IdeaVerse
        ideaCategories: {}, ideaTemplates: {}, savedIdeas: [] 
    };

    // --- DOM ELEMENTS ---
    const dom = {
        appContainer: document.getElementById('app-container'),
        savedContainer: document.getElementById('saved-container'),
        stylistContainer: document.getElementById('stylist-container'),
        ideaverseContainer: document.getElementById('ideaverse-container'), 
        header: document.getElementById('header'),
        galleryContainer: document.getElementById('gallery-container'),
        gridContainer: document.getElementById('grid-container'),
        slideCounter: document.getElementById('slide-counter'),
        menuBtn: document.getElementById('menu-btn'),
        mainMenu: document.getElementById('main-menu'),
        tabsContainer: document.querySelector('.tabs'),
        tabs: document.querySelectorAll('.tab-btn'),
        notification: document.getElementById('notification'),
        appTitle: document.getElementById('app-title'),
        pageViewTitle: document.getElementById('page-view-title'),
        backBtnHeader: document.getElementById('back-btn-header'),
        searchBtn: document.getElementById('search-btn'),
        refreshBtn: document.getElementById('refresh-btn'),
        searchInput: document.getElementById('search-input'),
        closeSearchBtn: document.getElementById('close-search-btn'),
        pageOverlay: document.getElementById('page-overlay'),
        pageTitle: document.querySelector('.page-title'),
        pageBody: document.querySelector('.page-body'),
        closePageBtn: document.getElementById('close-page-btn'),
        alertOverlay: document.getElementById('alert-overlay'),
        alertBox: document.getElementById('alert-box'),
        alertMessage: document.getElementById('alert-message'),
        alertDontShowAgain: document.getElementById('alert-dont-show-again'),
        alertCancelBtn: document.getElementById('alert-cancel-btn'),
        alertConfirmBtn: document.getElementById('alert-confirm-btn')
    };

    // --- In-App Page Content ---
    const pageContentData = { 'about': { title: 'About Us', content: `<h2>Welcome to PDX Prompt!</h2><p>Our mission is to provide high-quality, inspiring prompts and ideas for creators of all kinds.</p><h2>Contact Us</h2><p>For any inquiries, contact us at: <strong>pdxdigitalteam@gmail.com</strong></p>` }, 'terms': { title: 'Terms of Service', content: `<p><strong>Last Updated:</strong> ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</p><p>By using PDX Prompt, you agree to these terms. Please use the service responsibly.</p>` }, 'privacy': { title: 'Privacy Policy', content: `<p><strong>Last Updated:</strong> ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</p><h3>Information We Collect</h3><p><strong>Locally Stored Data:</strong> "Saved Prompts", "Liked Prompts", and "Saved Ideas" are stored only on your device. This data is never sent to our servers.</p><p><strong>Anonymized Data:</strong> When you like a prompt, we send an anonymous request to Google Firebase to update the public like count. Firebase may collect your IP address for security and analytics, as per Google's Privacy Policy.</p><h3>Information We Do Not Collect</h3><p>We do not collect any personal information like your name, email, or phone number.</p>` }, 'version': { title: 'App Version', content: `<p>Current version: <strong>v11.0 (Final & Fixed)</strong></p>` }, 'contact': { title: 'Contact Us', content: `<p>Email us at: <strong>pdxdigitalteam@gmail.com</strong></p>` } };
    
    // --- ROUTING ---
    function navigateTo(path) { window.location.hash = path; }
    async function router() {
        const hash = window.location.hash || '#/new';
        const [path, param] = hash.substring(2).split('/');
        
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        dom.appContainer.classList.remove('grid-mode', 'slider-mode', 'search-mode-active');
        deactivateSearchMode(false);
        if (appState.isLoading) return;

        switch (path) {
            case 'saved': await renderSavedScreen(); dom.savedContainer.classList.add('active'); break;
            case 'stylist': renderStylistView(); dom.stylistContainer.classList.add('active'); break;
            case 'ideaverse': renderIdeaVerse(); dom.ideaverseContainer.classList.add('active'); break;
            case 'tag': await renderTagView(param); dom.appContainer.classList.add('active'); break;
            case 'foryou': case 'new': case 'trending': appState.currentTab = path; await renderMainView(); dom.appContainer.classList.add('active'); break;
            case 'prompt': await renderSinglePromptView(param); dom.appContainer.classList.add('active'); break;
            default:
                appState.currentTab = 'new';
                await renderMainView();
                dom.appContainer.classList.add('active');
                window.history.replaceState(null, '', '#/new');
                break;
        }

        const loader = document.getElementById('initial-loader');
        if (loader) {
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 300);
        }
    }

    // --- DATA FETCHING & CORE APP LOGIC ---
    async function loadInitialData(forceRefresh = false) {
        if (appState.isLoading && !forceRefresh) return;
        appState.isLoading = true;
        showLoader();
        dom.refreshBtn.classList.add('refreshing');
        
        if (forceRefresh) {
            Object.assign(appState, { allPrompts: {}, forYouData: [], trendingData: [], newData: [], hasMoreNewData: true, lastNewPromptTimestamp: null, ideaCategories: {}, ideaTemplates: {} });
        }
        
        try {
            // Fetch all data in parallel for speed
            const [promptsSnapshot, homepageSnapshot, ideaCategoriesSnapshot, ideaTemplatesSnapshot] = await Promise.all([
                promptsRef.orderByChild('timestamp').once('value'), // Fetch all prompts sorted by time
                homepageRef.once('value'),
                ideaCategoriesRef.once('value'),
                ideaTemplatesRef.once('value')
            ]);
            
            const allPromptsData = promptsSnapshot.val() || {};
            const allPromptsArray = Object.entries(allPromptsData)
                .map(([id, data]) => ({ id, ...data, tags: data.tags || [] }))
                .reverse(); // Newest first

            allPromptsArray.forEach(p => appState.allPrompts[p.id] = p);
            
            const homepageConfig = homepageSnapshot.val() || { forYou: [], trending: [] };
            appState.forYouData = (homepageConfig.forYou || []).map(id => appState.allPrompts[id]).filter(Boolean);
            appState.trendingData = (homepageConfig.trending || []).map(id => appState.allPrompts[id]).filter(Boolean);
            
            appState.newData = allPromptsArray.slice(0, PAGE_SIZE);
            if(appState.newData.length > 0) {
                appState.lastNewPromptTimestamp = appState.newData[appState.newData.length - 1].timestamp;
                appState.hasMoreNewData = allPromptsArray.length > PAGE_SIZE;
            } else {
                 appState.hasMoreNewData = false;
            }
            
            // CORRECTLY load IdeaVerse data
            appState.ideaCategories = ideaCategoriesSnapshot.val() || {};
            appState.ideaTemplates = ideaTemplatesSnapshot.val() || {};
            
        } catch (error) { 
            console.error("Failed to load initial data:", error); 
            showError("Could not load content.");
        } 
        finally { 
            appState.isLoading = false; 
            setTimeout(() => dom.refreshBtn.classList.remove('refreshing'), 500);
        }
    }

    async function fetchPromptById(id) { if (appState.allPrompts[id]) return appState.allPrompts[id]; const snapshot = await db.ref(`prompts/${id}`).once('value'); const promptData = snapshot.val(); if (promptData) { const prompt = { id, ...promptData, tags: promptData.tags || [] }; appState.allPrompts[id] = prompt; return prompt; } return null; }
    async function loadMoreNewPrompts() { if (appState.isLoadingMore || !appState.hasMoreNewData) return; appState.isLoadingMore = true; try { const query = promptsRef.orderByChild('timestamp').endBefore(appState.lastNewPromptTimestamp).limitToLast(PAGE_SIZE); const snapshot = await query.once('value'); const morePromptsData = snapshot.val() || {}; const morePromptsArray = Object.entries(morePromptsData).map(([id, data]) => ({ id, ...data, tags: data.tags || [] })).sort((a, b) => b.timestamp - a.timestamp); if (morePromptsArray.length > 0) { appState.newData.push(...morePromptsArray); morePromptsArray.forEach(p => { appState.allPrompts[p.id] = p; }); appState.lastNewPromptTimestamp = morePromptsArray[morePromptsArray.length - 1].timestamp; createSlides(morePromptsArray, dom.galleryContainer, true); appState.slides = dom.galleryContainer.querySelectorAll('.slide'); updateUIForCurrentSlide(); } if (morePromptsArray.length < PAGE_SIZE) appState.hasMoreNewData = false; } catch(error) { console.error("Error loading more prompts:", error); } finally { appState.isLoadingMore = false; } }
    async function renderMainView() { const dataMap = { foryou: appState.forYouData, new: appState.newData, trending: appState.trendingData }; const viewModeMap = { foryou: 'slider', new: 'slider', trending: 'grid' }; const data = dataMap[appState.currentTab] || []; const viewMode = viewModeMap[appState.currentTab] || 'slider'; updateHeaderUI(false, "PDX Prompt"); dom.tabsContainer.style.display = 'flex'; dom.tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === appState.currentTab)); if (viewMode === 'slider') { appState.currentSlideData = data; renderSliderView(data); } else { renderGridView(data); } }
    function renderSliderView(data, startIndex = 0) { dom.appContainer.classList.remove('grid-mode'); dom.appContainer.classList.add('slider-mode'); dom.galleryContainer.innerHTML = ''; dom.slideCounter.style.display = 'block'; if (data && data.length > 0) { createSlides(data, dom.galleryContainer); appState.slides = dom.galleryContainer.querySelectorAll('.slide'); appState.currentIndex = startIndex; if (appState.slides[startIndex]) { appState.slides[startIndex].classList.add('active'); preloadImageForSlide(startIndex); } updateUIForCurrentSlide(); } else { showError("No prompts found.", dom.galleryContainer); } }
    function renderGridView(data, isSearch = false, fromTag = false) { dom.appContainer.classList.remove('slider-mode'); dom.appContainer.classList.add('grid-mode'); dom.gridContainer.innerHTML = ''; const grid = document.createElement('div'); grid.className = 'grid'; if (data && data.length > 0) { data.forEach(item => { const gridItem = document.createElement('div'); gridItem.className = 'grid-item'; gridItem.innerHTML = `<img src="${item.imageUrl}" alt="thumbnail" loading="lazy"> ${item.isPinned ? '<div class="pin-indicator"><i class="fas fa-thumbtack"></i></div>' : ''}`; gridItem.onclick = () => { const idx = data.findIndex(i => i.id === item.id); renderSliderView(data, Math.max(0, idx)); let title = "Results"; if(fromTag) title = `#${decodeURIComponent(window.location.hash.split('/')[2])}`; else if (isSearch) title = "Search Results"; else title = "Trending"; updateHeaderUI(true, title); }; grid.appendChild(gridItem); }); dom.gridContainer.appendChild(grid); } else { showError(isSearch ? "No results found." : "No prompts in this category.", dom.gridContainer); } }
    async function renderSavedScreen() { const savedHeaderH1 = dom.savedContainer.querySelector('.saved-header h1'); if (savedHeaderH1) savedHeaderH1.style.paddingRight = '0'; const savedData = (await Promise.all(appState.savedItems.map(fetchPromptById))).filter(Boolean).reverse(); const wrapper = dom.savedContainer.querySelector('.saved-list-wrapper'); let listHTML = savedData.length > 0 ? savedData.map(item => `<div class="saved-item" data-id="${item.id}"><img src="${item.imageUrl}" alt="thumbnail"><span>${item.prompt}</span><button class="delete-saved-btn" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button></div>`).join('') : `<p class="no-saved-message">You haven't saved any prompts yet.</p>`; wrapper.innerHTML = `<div class="saved-list">${listHTML}</div>`; wrapper.querySelectorAll('.saved-item').forEach(el => { el.onclick = (e) => { if (!e.target.closest('.delete-saved-btn')) navigateTo(`/prompt/${el.dataset.id}`); }; }); wrapper.querySelectorAll('.delete-saved-btn').forEach(btn => { btn.onclick = (e) => { e.stopPropagation(); deleteSavedPrompt(btn.dataset.id); }; }); }
    async function renderSinglePromptView(promptId) { const prompt = await fetchPromptById(promptId); if (prompt) { appState.currentSlideData = [prompt]; renderSliderView([prompt]); updateHeaderUI(true, "Prompt"); } else { showNotification("Sorry, this prompt could not be found."); navigateTo(`/${appState.currentTab}`); } }
    async function renderTagView(tag) { const tagName = decodeURIComponent(tag); updateHeaderUI(true, `#${tagName}`); dom.tabsContainer.style.display = 'none'; const allPrompts = Object.values(appState.allPrompts); const taggedPrompts = allPrompts.filter(p => p.tags && p.tags.includes(tagName)); renderGridView(taggedPrompts, false, true); }
    function createSlides(items, container, isAppending = false) { const fragment = document.createDocumentFragment(); items.forEach((item) => { const slide = document.createElement("div"); slide.className = "slide"; slide.dataset.id = item.id; const isSaved = appState.savedItems.includes(item.id), isLiked = appState.likedItems.includes(item.id); const tagsHTML = (item.tags || []).map(tag => `<span class="tag" data-tag="${tag}">${tag}</span>`).join(''); slide.innerHTML = `<div class="image-wrapper"><div class="image-container"><img data-src="${item.imageUrl}" alt="AI Generated Image"></div></div> <div class="prompt-card"> ${item.isPinned ? '<div class="pin-indicator" style="top:10px;left:10px;"><i class="fas fa-thumbtack"></i></div>' : ''} <div class="prompt-actions"> <div class="action-icon like-btn ${isLiked ? 'active' : ''}"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i></div> <div class="action-icon share-btn"><i class="fas fa-share-alt"></i></div> <div class="action-icon save-btn ${isSaved ? 'active' : ''}"><i class="${isSaved ? 'fas' : 'far'} fa-bookmark"></i></div> </div> <div class="prompt-meta-container"> <div class="prompt-title">AI Image Prompt</div> <div class="like-count-display"><i class="fas fa-heart"></i><span id="like-count-${item.id}">${item.likeCount || 0}</span></div> </div> <div class="tags-container">${tagsHTML}</div> <div class="prompt-text"></div> <div class="action-buttons"> <button class="action-btn copy-btn"><i class="fas fa-copy"></i> Copy</button> ${item.appLink ? `<button class="action-btn generator-btn"><i class="fas fa-pencil-alt"></i> Generator</button>` : ''} </div> </div>`; slide.querySelector('.prompt-text').textContent = item.prompt; slide.querySelector('.like-btn').onclick = (e) => { e.stopPropagation(); toggleLike(e.currentTarget, item.id); }; slide.querySelector('.share-btn').onclick = (e) => { e.stopPropagation(); sharePrompt(item.prompt); }; slide.querySelector('.save-btn').onclick = (e) => { e.stopPropagation(); toggleSave(e.currentTarget, item.id); }; slide.querySelector('.copy-btn').onclick = (e) => { e.stopPropagation(); copyPrompt(item.prompt); }; const generatorBtn = slide.querySelector('.generator-btn'); if (generatorBtn && item.appLink) { generatorBtn.onclick = (e) => { e.stopPropagation(); handleGeneratorLink(item.appLink); }; } slide.querySelectorAll('.tag').forEach(tagEl => { tagEl.onclick = () => navigateTo(`/tag/${tagEl.dataset.tag}`); }); fragment.appendChild(slide); }); if(isAppending) { container.appendChild(fragment); } else { container.innerHTML = ''; container.appendChild(fragment); } }
    function deleteSavedPrompt(promptId) { appState.savedItems = appState.savedItems.filter(id => id !== promptId); localStorage.setItem("pdxSavedPrompts", JSON.stringify(appState.savedItems)); const itemElement = dom.savedContainer.querySelector(`.saved-item[data-id="${promptId}"]`); if (itemElement) { itemElement.style.transition = 'opacity 0.3s, transform 0.3s'; itemElement.style.opacity = '0'; itemElement.style.transform = 'translateX(-20px)'; setTimeout(() => { itemElement.remove(); if (appState.savedItems.length === 0) { dom.savedContainer.querySelector('.saved-list-wrapper').innerHTML = `<div class="saved-list"><p class="no-saved-message">You haven't saved any prompts yet.</p></div>`; } }, 300); } const openSlide = dom.appContainer.querySelector(`.slide[data-id="${promptId}"]`); if(openSlide) { const saveBtn = openSlide.querySelector('.save-btn'); if(saveBtn) { saveBtn.classList.remove('active'); saveBtn.querySelector('i').classList.remove('fas'); saveBtn.querySelector('i').classList.add('far'); } } showNotification("Prompt removed from saved items."); }
    function setupEventListeners() { document.addEventListener("DOMContentLoaded", async () => { appState.savedItems = JSON.parse(localStorage.getItem("pdxSavedPrompts")) || []; appState.likedItems = JSON.parse(localStorage.getItem("pdxLikedPrompts")) || []; appState.savedIdeas = JSON.parse(localStorage.getItem("pdxSavedIdeas")) || []; await loadInitialData(); router(); }); window.addEventListener('hashchange', router); dom.tabs.forEach(tab => { tab.onclick = () => navigateTo(`/${tab.dataset.tab}`); }); let startY, startX, swipeThreshold = 50; dom.appContainer.addEventListener('touchstart', (e) => { if (dom.appContainer.classList.contains('slider-mode')) { startX = e.touches[0].clientX; startY = e.touches[0].clientY; } }, { passive: true }); dom.appContainer.addEventListener('touchmove', (e) => { if (!startY) return; const dY = e.touches[0].clientY - startY, dX = e.touches[0].clientX - startX; if (Math.abs(dY) > Math.abs(dX) && Math.abs(dY) > swipeThreshold) { goToSlide(appState.currentIndex + (dY < 0 ? 1 : -1)); startY = null; } }, { passive: true }); dom.appContainer.addEventListener('touchend', () => { startY = null; startX = null; }); dom.refreshBtn.onclick = () => { loadInitialData(true).then(router); }; dom.menuBtn.onclick = toggleMenu; const ideaMenuBtn = document.getElementById('menu-btn-ideaverse'); if(ideaMenuBtn) ideaMenuBtn.onclick = toggleMenu; dom.backBtnHeader.onclick = () => window.history.back(); document.querySelector('#saved-container .back-btn').onclick = () => window.history.back(); const ideaBackBtn = document.getElementById('ideaverse-back-btn'); if(ideaBackBtn) ideaBackBtn.onclick = () => window.history.back(); dom.searchBtn.onclick = activateSearchMode; dom.closeSearchBtn.onclick = () => deactivateSearchMode(true); dom.searchInput.addEventListener('input', () => { clearTimeout(appState.searchDebounceTimeout); appState.searchDebounceTimeout = setTimeout(performSearch, 300); }); document.addEventListener('click', (e) => { if (dom.mainMenu.classList.contains('open') && !e.target.closest('#main-menu') && !e.target.closest('.top-button')) toggleMenu(); }); dom.closePageBtn.onclick = hideInAppPage; dom.pageOverlay.onclick = (e) => { if (e.target === dom.pageOverlay) hideInAppPage(); }; setupStylistActionButtons(); }
    function handleGeneratorLink(url) { const shouldShowAlert = localStorage.getItem('pdxDontShowGeneratorAlert') !== 'true'; if (shouldShowAlert) { dom.alertMessage.textContent = `You are about to leave PDX Prompt and open an external website. Do you want to continue?`; dom.alertOverlay.classList.add('show'); dom.alertConfirmBtn.onclick = () => { if (dom.alertDontShowAgain.checked) localStorage.setItem('pdxDontShowGeneratorAlert', 'true'); window.open(url, '_blank'); dom.alertOverlay.classList.remove('show'); }; dom.alertCancelBtn.onclick = () => dom.alertOverlay.classList.remove('show'); dom.alertOverlay.onclick = (e) => { if (e.target === dom.alertOverlay) dom.alertOverlay.classList.remove('show'); }; } else { window.open(url, '_blank'); } }
    function toggleLike(btnElement, id) { const icon = btnElement.querySelector('i'), hasLiked = appState.likedItems.includes(id), increment = hasLiked ? -1 : 1; appState.likedItems = hasLiked ? appState.likedItems.filter(likedId => likedId !== id) : [...appState.likedItems, id]; btnElement.classList.toggle('active'); icon.classList.toggle('fas'); icon.classList.toggle('far'); localStorage.setItem("pdxLikedPrompts", JSON.stringify(appState.likedItems)); db.ref(`prompts/${id}/likeCount`).transaction(currentLikes => (currentLikes || 0) + increment).then(res => { if (res.committed) { const newLikes = res.snapshot.val(); if(appState.allPrompts[id]) appState.allPrompts[id].likeCount = newLikes; const span = document.getElementById(`like-count-${id}`); if (span) span.textContent = newLikes; } }); }
    function toggleSave(btnElement, id) { btnElement.classList.toggle('active'); btnElement.querySelector('i').classList.toggle('far'); btnElement.querySelector('i').classList.toggle('fas'); const itemIndex = appState.savedItems.indexOf(id); if (itemIndex > -1) appState.savedItems.splice(itemIndex, 1); else appState.savedItems.push(id); localStorage.setItem("pdxSavedPrompts", JSON.stringify(appState.savedItems)); }
    
    async function copyPrompt(text) {
        if (!text || text.trim() === '' || text.trim() === 'Click "Generate New Idea" to begin!' || text.trim() === 'Choose an option to begin...') {
            showNotification('Nothing to copy yet!');
            return;
        }
        if (navigator.clipboard && window.isSecureContext) {
            try { await navigator.clipboard.writeText(text); showNotification('Copied to clipboard!'); return; } catch (err) { console.error('Clipboard API failed, falling back...', err); }
        }
        try { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = 'fixed'; textArea.style.top = '-9999px'; textArea.style.left = '-9999px'; document.body.appendChild(textArea); textArea.focus(); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); showNotification('Copied!'); } catch (err) { console.error('Fallback copy failed: ', err); showNotification('Could not copy.'); }
    }

    async function sharePrompt(promptText) { if (navigator.share) { try { await navigator.share({ title: 'AI Art Prompt from PDX Prompt', text: `${promptText}\n\nShared from PDX Prompt App`, }); } catch (error) { if (error.name !== 'AbortError') { console.error('Error sharing:', error); } } } else { copyPrompt(promptText); showNotification('Share not supported, prompt copied instead!'); } }
    function goToSlide(newIndex) { if (appState.currentTab === 'new' && newIndex >= appState.newData.length - 5 && !appState.isLoadingMore) loadMoreNewPrompts(); if (!appState.slides || newIndex < 0 || newIndex >= appState.slides.length || newIndex === appState.currentIndex) return; appState.slides[appState.currentIndex].classList.remove('active'); appState.slides[appState.currentIndex].classList.add(newIndex > appState.currentIndex ? 'prev' : 'next'); appState.slides[newIndex].classList.remove('prev', 'next'); appState.slides[newIndex].classList.add('active'); appState.currentIndex = newIndex; preloadImageForSlide(newIndex); updateUIForCurrentSlide(); }
    function performSearch() { const query = dom.searchInput.value.toLowerCase().trim(); if (!query) { dom.gridContainer.innerHTML = ''; return; } const results = Object.values(appState.allPrompts).filter(p => p.prompt && p.prompt.toLowerCase().includes(query) || (p.tags && p.tags.some(t => t.includes(query)))); renderGridView(results, true); updateHeaderUI(true, "Search Results"); }
    function activateSearchMode() { appState.isSearchActive = true; dom.header.classList.add('search-active'); dom.appContainer.classList.add('search-mode-active', 'grid-mode'); dom.appContainer.classList.remove('slider-mode'); dom.tabsContainer.style.display = 'none'; dom.slideCounter.style.display = 'none'; dom.searchInput.focus(); performSearch(); }
    function deactivateSearchMode(fromButtonClick) { if (!appState.isSearchActive) return; appState.isSearchActive = false; dom.header.classList.remove('search-active'); dom.searchInput.value = ''; if (fromButtonClick) router(); }
    function updateHeaderUI(showBackBtn, titleText = "PDX Prompt") { dom.backBtnHeader.style.display = showBackBtn ? 'flex' : 'none'; dom.searchBtn.style.display = showBackBtn ? 'none' : 'flex'; dom.appTitle.style.display = !showBackBtn || titleText === "PDX Prompt" ? 'block' : 'none'; dom.pageViewTitle.style.display = showBackBtn && titleText !== "PDX Prompt" ? 'block' : 'none'; dom.pageViewTitle.textContent = titleText; }
    function updateUIForCurrentSlide() { if (dom.slideCounter) { const total = appState.currentSlideData.length; dom.slideCounter.textContent = total > 0 ? `${appState.currentIndex + 1}/${total}` : "0/0"; clearTimeout(appState.slideCounterTimeout); dom.slideCounter.classList.add('show'); appState.slideCounterTimeout = setTimeout(() => dom.slideCounter.classList.remove('show'), 2000); } }
    function toggleMenu() { const isOpen = dom.mainMenu.classList.contains('open'); if(!isOpen) buildMenu(); document.querySelector('.view.active').classList.toggle('menu-open', !isOpen); dom.mainMenu.classList.toggle('open', !isOpen); }
    function buildMenu() { dom.mainMenu.innerHTML = ` <div class="menu-header"><div class="menu-title">Menu</div><button class="close-menu"><i class="fas fa-times"></i></button></div> <div class="menu-section"><div class="menu-section-title"><i class="fas fa-rocket"></i>The Universe</div> <div class="menu-item" id="menu-idea-verse"><i class="fas fa-meteor"></i><span class="menu-item-text">Enter IdeaVerse</span></div> </div> <div class="menu-section"><div class="menu-section-title"><i class="fas fa-palette"></i>AI Art</div> <div class="menu-item" id="menu-ai-prompts"><i class="fas fa-image"></i><span class="menu-item-text">AI Art Prompts</span></div> <div class="menu-item" id="menu-view-saved"><i class="fas fa-bookmark"></i><span class="menu-item-text">Saved Prompts</span></div> <div class="menu-item" id="menu-ai-stylist"><i class="fas fa-wand-magic-sparkles"></i><span class="menu-item-text">AI Prompt Wizard</span></div> </div> <div class="menu-section"><div class="menu-section-title"><i class="fas fa-info-circle"></i>Information</div> <div class="menu-item" data-page="about"><i class="fas fa-users"></i><span class="menu-item-text">About Us</span></div> <div class="menu-item" data-page="terms"><i class="fas fa-file-contract"></i><span class="menu-item-text">Terms of Service</span></div> <div class="menu-item" data-page="privacy"><i class="fas fa-shield-alt"></i><span class="menu-item-text">Privacy Policy</span></div> <div class="menu-item" data-page="version"><i class="fas fa-code-branch"></i><span class="menu-item-text">App Version</span></div> <div class="menu-item" data-page="contact"><i class="fas fa-envelope"></i><span class="menu-item-text">Contact Us</span></div> </div>`; dom.mainMenu.querySelector('.close-menu').onclick = toggleMenu; dom.mainMenu.querySelector('#menu-ai-prompts').onclick = () => { navigateTo('/new'); toggleMenu(); }; dom.mainMenu.querySelector('#menu-idea-verse').onclick = () => { navigateTo('/ideaverse'); toggleMenu(); }; dom.mainMenu.querySelector('#menu-view-saved').onclick = () => { navigateTo('/saved'); toggleMenu(); }; dom.mainMenu.querySelector('#menu-ai-stylist').onclick = () => { navigateTo('/stylist'); toggleMenu(); }; dom.mainMenu.querySelectorAll('.menu-item[data-page]').forEach(item => { item.onclick = () => { showInAppPage(item.dataset.page); toggleMenu(); }; }); }
    function showInAppPage(pageKey) { const data = pageContentData[pageKey]; if (!data) return; dom.pageTitle.textContent = data.title; dom.pageBody.innerHTML = data.content; dom.pageOverlay.classList.add('show'); document.body.querySelector('.view.active').classList.add('page-open'); }
    function hideInAppPage() { dom.pageOverlay.classList.remove('show'); document.body.querySelector('.view.active').classList.remove('page-open'); }
    function showLoader() { const gallery = dom.galleryContainer; if(gallery) gallery.innerHTML = '<div class="loader"></div>'; const grid = dom.gridContainer; if(grid) grid.innerHTML = ''; }
    function showError(message, container) { const target = container || dom.galleryContainer; if (target) target.innerHTML = `<div class="error-message">${message}</div>`; }
    function showNotification(msg) { let notification = document.getElementById('notification'); if (!notification) { notification = document.createElement('div'); notification.id = 'notification'; document.body.appendChild(notification); } notification.textContent = msg; notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 2000); }
    function preloadImageForSlide(index) { if (!appState.slides || !appState.slides[index]) return; const img = appState.slides[index].querySelector('img'); if (img && !img.src && img.dataset.src) img.src = img.dataset.src; }
    
    // --- CORRECTED IDEA-VERSE LOGIC ---
    function renderIdeaVerse() {
        renderIdeaVerseWelcomeScreen();
        // Set the back button to go to the main app, not deeper into ideaverse
        document.getElementById('ideaverse-back-btn').onclick = () => navigateTo('/new');
    }

    function renderIdeaVerseWelcomeScreen() {
        document.getElementById('ideaverse-header-title').textContent = "IdeaVerse";
        const content = document.getElementById('ideaverse-content');

        if (!appState.ideaCategories || Object.keys(appState.ideaCategories).length === 0) {
            content.innerHTML = `<div class="error-message">No idea categories found. Add some from your admin panel!</div>`;
            return;
        }

        let categoryHTML = Object.entries(appState.ideaCategories).map(([key, {title, icon}]) => `
            <div class="idea-category-card" data-category="${key}">
                <i class="fas ${icon}"></i>
                <span>${title}</span>
            </div>
        `).join('');

        content.innerHTML = `
            <div class="ideaverse-welcome-screen">
                <h2 class="ideaverse-title">Welcome to the IdeaVerse</h2>
                <p class="ideaverse-subtitle">What do you seek inspiration for today?</p>
                <div class="ideaverse-category-grid">${categoryHTML}</div>
            </div>
        `;

        content.querySelectorAll('.idea-category-card').forEach(card => {
            card.onclick = () => renderIdeaGeneratorScreen(card.dataset.category);
        });
        
        // When on the welcome screen, back button goes to main app
        document.getElementById('ideaverse-back-btn').onclick = () => navigateTo('/new');
    }

    function renderIdeaGeneratorScreen(categoryKey) {
        const category = appState.ideaCategories[categoryKey];
        if (!category) return;

        document.getElementById('ideaverse-header-title').textContent = category.title;
        const content = document.getElementById('ideaverse-content');

        content.innerHTML = `
            <div class="ideaverse-generator-screen">
                <p class="ideaverse-subtitle">Tap the button to discover a new idea!</p>
                <div id="idea-card">Click "Generate New Idea" to begin!</div>
                <button id="generate-idea-btn"><i class="fas fa-lightbulb"></i> Generate New Idea</button>
                <div class="idea-actions" style="visibility: hidden;">
                    <button id="idea-save-btn" class="idea-action-btn"><i class="far fa-bookmark"></i> Save Idea</button>
                    <button id="idea-copy-btn" class="idea-action-btn"><i class="fas fa-copy"></i> Copy</button>
                </div>
            </div>
        `;
        
        const generateBtn = document.getElementById('generate-idea-btn');
        const ideaCard = document.getElementById('idea-card');
        const ideaActions = document.querySelector('.idea-actions');

        generateBtn.onclick = () => {
            ideaCard.classList.add('generating');
            generateBtn.disabled = true;
            setTimeout(() => {
                const idea = generateIdeaForCategory(categoryKey);
                ideaCard.textContent = idea;
                ideaCard.classList.remove('generating');
                generateBtn.disabled = false;
                ideaActions.style.visibility = 'visible';
            }, 600);
        };
        
        document.getElementById('idea-copy-btn').onclick = () => copyPrompt(ideaCard.textContent);
        document.getElementById('idea-save-btn').onclick = () => saveGeneratedIdea(ideaCard.textContent);

        // When on the generator screen, back button goes to welcome screen
        document.getElementById('ideaverse-back-btn').onclick = renderIdeaVerseWelcomeScreen;
    }

    function generateIdeaForCategory(categoryKey) {
        // Filter templates based on the new, correct structure
        const templatesForCategory = Object.values(appState.ideaTemplates).filter(t => t.category === categoryKey);

        if (templatesForCategory.length === 0) {
            return `No ideas found for '${appState.ideaCategories[categoryKey]?.title || categoryKey}'. Please add templates in the admin panel.`;
        }

        const randomTemplate = templatesForCategory[Math.floor(Math.random() * templatesForCategory.length)];
        
        // Use the new template and placeholders format
        if (!randomTemplate.template) return "Template format is incorrect.";

        let finalIdea = randomTemplate.template.replace(/\{(\w+)\}/g, (match, placeholderKey) => {
            if (randomTemplate.placeholders && randomTemplate.placeholders[placeholderKey] && Array.isArray(randomTemplate.placeholders[placeholderKey])) {
                const options = randomTemplate.placeholders[placeholderKey];
                return options[Math.floor(Math.random() * options.length)];
            }
            return match; // Return the placeholder itself if no options are found
        });
        return finalIdea;
    }

    function saveGeneratedIdea(ideaText) {
        if (!appState.savedIdeas.includes(ideaText)) {
            appState.savedIdeas.push(ideaText);
            localStorage.setItem("pdxSavedIdeas", JSON.stringify(appState.savedIdeas));
            showNotification("Idea saved!");
        } else {
            showNotification("You've already saved this idea!");
        }
    }

    // --- AI STYLIST WIZARD LOGIC (Remains the same) ---
    const stylistWizardData = {
        start: { question: { en: "What is the main subject of your image?", hi: "      ?" }, options: [ { value: 'character', label: { en: 'Character', hi: '' }, icon: 'fa-user-astronaut', next: 'character_gender' }, { value: 'animal', label: { en: 'Animal', hi: '' }, icon: 'fa-paw', next: 'animal_type' }, { value: 'landscape', label: { en: 'Landscape', hi: '' }, icon: 'fa-mountain-sun', next: 'landscape_type' }, { value: 'vehicle', label: { en: 'Vehicle', hi: '' }, icon: 'fa-car-side', next: 'art_style' }, { value: 'object', label: { en: 'Object', hi: '' }, icon: 'fa-gem', next: 'art_style' }, ], key: 'subject' },
        character_gender: { question: { en: "Select the character's gender", hi: "   " }, options: [ { value: 'a beautiful woman', label: { en: 'Woman', hi: '' }, icon: 'fa-person-dress', next: 'character_details' }, { value: 'a handsome man', label: { en: 'Man', hi: '' }, icon: 'fa-person', next: 'character_details' }, ], key: 'description' },
        character_details: { question: { en: "Add some details", hi: "  " }, isMultiSelect: true, options: [ { value: 'with long hair', label: { en: 'Long Hair', hi: ' ' }, icon: 'fa-user-ninja' }, { value: 'with blue eyes', label: { en: 'Blue Eyes', hi: ' ' }, icon: 'fa-eye' }, { value: 'smiling happily', label: { en: 'Smiling', hi: ' ' }, icon: 'fa-smile' }, { value: 'wearing futuristic cyberpunk armor', label: { en: 'Cyberpunk Armor', hi: ' ' }, icon: 'fa-robot' }, { value: 'wearing a traditional Indian Saree', label: { en: 'Indian Saree', hi: ' ' }, icon: 'fa-om' }, { value: 'holding a sword', label: { en: 'Holding a Sword', hi: '  ' }, icon: 'fa-khanda' }, ], key: 'details', next: 'art_style' },
        animal_type: { question: { en: "Which animal?", hi: "  ?" }, options: [ { value: 'a majestic lion', label: { en: 'Lion', hi: '' }, icon: 'fa-cat', next: 'art_style' }, { value: 'a mystical wolf', label: { en: 'Wolf', hi: '' }, icon: 'fa-dog', next: 'art_style' }, { value: 'a powerful eagle', label: { en: 'Eagle', hi: '' }, icon: 'fa-dove', next: 'art_style' }, { value: 'a mythical dragon', label: { en: 'Dragon', hi: '' }, icon: 'fa-dragon', next: 'art_style' }, ], key: 'description', },
        landscape_type: { question: { en: "What kind of landscape?", hi: "   ?" }, options: [ { value: 'a mystical enchanted forest', label: { en: 'Enchanted Forest', hi: ' ' }, icon: 'fa-tree', next: 'landscape_details' }, { value: 'a futuristic cyberpunk city', label: { en: 'Cyberpunk City', hi: ' ' }, icon: 'fa-city', next: 'landscape_details' }, ], key: 'description' },
        landscape_details: { question: { en: "What's happening in the scene?", hi: "     ?" }, isMultiSelect: true, options: [ { value: 'with a river flowing through it', label: { en: 'Flowing River', hi: ' ' }, icon: 'fa-water' }, { value: 'with a glowing full moon', label: { en: 'Full Moon', hi: '' }, icon: 'fa-moon' }, ], key: 'details', next: 'art_style' },
        art_style: { question: { en: "Choose an art style", hi: "   " }, isMultiSelect: true, options: [ { value: 'photorealistic', label: { en: 'Photorealistic', hi: '-' }, icon: 'fa-camera' }, { value: 'digital painting', label: { en: 'Digital Art', hi: ' ' }, icon: 'fa-palette' }, { value: 'anime style', label: { en: 'Anime', hi: '' }, icon: 'fa-pen-nib' }, { value: '3D render, Pixar style', label: { en: '3D Render', hi: '3D ' }, icon: 'fa-cubes' }, { value: 'cinematic', label: { en: 'Cinematic', hi: '' }, icon: 'fa-film' }, ], key: 'style', next: 'camera_shot' },
        camera_shot: { question: { en: "Select a camera shot", hi: "   " }, options: [ { value: 'close-up portrait', label: { en: 'Close-up', hi: '-' }, icon: 'fa-user', next: 'lighting' }, { value: 'full body shot', label: { en: 'Full Body', hi: ' ' }, icon: 'fa-person-walking', next: 'lighting' }, ], key: 'camera' },
        lighting: { question: { en: "How about the lighting?", hi: "  ?" }, options: [ { value: 'dramatic lighting', label: { en: 'Dramatic', hi: '' }, icon: 'fa-bolt', next: 'quality' }, { value: 'soft lighting', label: { en: 'Soft', hi: '' }, icon: 'fa-cloud', next: 'quality' }, ], key: 'lighting' },
        quality: { question: { en: "Finally, the image quality", hi: " ,   " }, options: [ { value: 'masterpiece, best quality, ultra-detailed', label: { en: 'Masterpiece', hi: '' }, icon: 'fa-trophy', next: 'final' }, { value: '8k, UHD', label: { en: 'Ultra HD', hi: ' HD' }, icon: 'fa-magnifying-glass-plus', next: 'final' }, ], key: 'quality' },
        final: { question: { en: "Your prompt is ready!", hi: "   !" }, isFinal: true }
    };
    function renderStylistView() { appState.stylistAnswers = {}; appState.stylistHistory = []; const wrapper = document.getElementById('stylist-content-wrapper'); wrapper.innerHTML = ''; renderStylistStep('start'); updateLivePrompt(); updateStylistUILanguage(); }
    function renderStylistStep(stepKey) { const stepData = stylistWizardData[stepKey]; if (!stepData) return; const lang = appState.currentLanguage; const wrapper = document.getElementById('stylist-content-wrapper'); if (stepData.isFinal) { const finalCard = document.createElement('div'); finalCard.className = 'stylist-final-card stylist-step'; finalCard.innerHTML = `<h2>${stepData.question[lang]}</h2><p>${ {en: 'You can copy the generated prompt from the bar below or start over.', hi: '                 '}[lang] }</p><button class="action-btn generator-btn" id="stylist-restart-final">${ {en: 'Create Another', hi: '  '}[lang] }</button>`; wrapper.innerHTML = ''; wrapper.appendChild(finalCard); wrapper.querySelector('#stylist-restart-final').onclick = renderStylistView; return; } const stepElement = document.createElement('div'); stepElement.className = 'stylist-step'; stepElement.id = `step-${stepKey}`; const totalSteps = Object.keys(stylistWizardData).length - 1; const currentStepIndex = appState.stylistHistory.length; const progress = (currentStepIndex / totalSteps) * 100; let optionsHTML = stepData.options.map(opt => `<div class="stylist-option-card" data-value="${opt.value}" data-next="${opt.next}" data-key="${stepData.key}"><i class="fas ${opt.icon}"></i><span>${opt.label[lang]}</span></div>`).join(''); stepElement.innerHTML = `<div class="stylist-progress-bar"><div class="stylist-progress-bar-inner" style="width: ${progress}%;"></div></div><h2 class="stylist-question">${stepData.question[lang]}</h2><div class="stylist-options-grid">${optionsHTML}</div>`; if(stepData.isMultiSelect){ const continueBtn = document.createElement('button'); continueBtn.className = 'action-btn copy-btn'; continueBtn.style.marginTop = '20px'; continueBtn.textContent = {en: 'Continue', hi: ' '}[lang]; continueBtn.onclick = () => { if((appState.stylistAnswers[stepData.key] && appState.stylistAnswers[stepData.key].length > 0) || !appState.stylistAnswers[stepData.key]) { appState.stylistHistory.push(stepKey); renderStylistStep(stepData.next); } else { showNotification({en: 'Please select at least one option.', hi: '      '}[lang]); } }; stepElement.appendChild(continueBtn); } wrapper.appendChild(stepElement); stepElement.scrollIntoView({ behavior: 'smooth', block: 'end' }); stepElement.querySelectorAll('.stylist-option-card').forEach(card => { card.onclick = () => { const { value, next, key } = card.dataset; if (stepData.isMultiSelect) { card.classList.toggle('selected'); const currentValues = appState.stylistAnswers[key] || []; if (card.classList.contains('selected')) { if (!currentValues.includes(value)) currentValues.push(value); } else { const index = currentValues.indexOf(value); if (index > -1) currentValues.splice(index, 1); } appState.stylistAnswers[key] = currentValues; } else { card.parentElement.querySelectorAll('.stylist-option-card').forEach(c => c.classList.remove('selected')); card.classList.add('selected'); appState.stylistAnswers[key] = value; appState.stylistHistory.push(stepKey); renderStylistStep(next); } updateLivePrompt(); }; }); }
    function updateLivePrompt() { const parts = []; const order = ['subject', 'description', 'details', 'style', 'camera', 'lighting', 'quality']; order.forEach(key => { const value = appState.stylistAnswers[key]; if (value) { if (Array.isArray(value) && value.length > 0) { parts.push(value.join(', ')); } else if (!Array.isArray(value)) { parts.push(value); } } }); const promptText = parts.filter(Boolean).join(', '); document.getElementById('live-prompt-output').textContent = promptText || {en: 'Choose an option to begin...', hi: '      ...'}[appState.currentLanguage]; }
    function updateStylistUILanguage() { const lang = appState.currentLanguage; document.getElementById('language-toggle-btn').textContent = lang.toUpperCase(); document.querySelector('#stylist-copy-btn span').textContent = {en:'Copy', hi:''}[lang]; document.querySelector('#stylist-reset-btn span').textContent = {en:'Reset', hi:''}[lang]; updateLivePrompt(); }
    function setupStylistActionButtons() { document.getElementById('stylist-copy-btn').onclick = () => { const textToCopy = document.getElementById('live-prompt-output').textContent; copyPrompt(textToCopy); }; document.getElementById('stylist-reset-btn').onclick = renderStylistView; document.getElementById('language-toggle-btn').onclick = () => { appState.currentLanguage = appState.currentLanguage === 'en' ? 'hi' : 'en'; renderStylistView(); }; document.getElementById('stylist-back-btn').onclick = () => { window.history.back(); }; }

    // --- INITIALIZE APP ---
    setupEventListeners();
</script>
</body>
</html>